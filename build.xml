<?xml version="1.0" encoding="UTF-8"?>
<project name="Zabbix" default="build" basedir=".">
	<property name="basedir" value="${WORKSPACE}"/>
	<property name="builddir" value="${BUILDDIR}"/>
	<property name="svn" value="${SVN}"/>
	<property name="dbtype" value="${DBTYPE}"/>
	<property name="dbname" value="${DBNAME}"/>
	<property name="url" value="${URL}"/>

	<target name="buildagent">
		<!-- Build agent binaries -->
		<exec executable="./configure" dir="${builddir}" failonerror="on">
			<arg value="--enable-agent"/>
		</exec>
		<exec executable="make" dir="${builddir}" failonerror="on"/>
	</target>

	<target name="buildserver">
		<!-- Build server binaries -->
		<exec executable="./configure" dir="${builddir}" failonerror="on">
			<arg value="--enable-server"/>
			<arg value="--with-${dbtype}"/>
			<arg value="--with-net-snmp"/>
			<arg value="--with-openipmi"/>
			<arg value="--with-ldap"/>
			<arg value="--with-ssh2"/>
			<arg value="--with-libcurl"/>
			<arg value="--with-jabber"/>
		</exec>
		<exec executable="make" dir="${builddir}" failonerror="on"/>
	</target>

	<target name="buildproxy">
		<!-- Build proxy binaries -->
		<exec executable="./configure" dir="${builddir}" failonerror="on">
			<arg value="--enable-proxy"/>
			<arg value="--with-${dbtype}"/>
			<arg value="--with-net-snmp"/>
			<arg value="--with-openipmi"/>
			<arg value="--with-ldap"/>
			<arg value="--with-ssh2"/>
			<arg value="--with-libcurl"/>
			<arg value="--with-jabber"/>
		</exec>
		<exec executable="make" dir="${builddir}" failonerror="on"/>
	</target>

	<target name="init-common">
		<!-- Create the different build directories -->
		<mkdir dir="${basedir}/build/logs" />
		<mkdir dir="${builddir}" />
		<exec executable="svn" dir="${basedir}/frontends/php/tests" failonerror="on">
			<arg line="checkout ${svn} ${builddir}"/>
		</exec>
		<exec executable="./bootstrap.sh" dir="${builddir}" failonerror="on"></exec>
		<exec executable="./configure" dir="${builddir}" failonerror="on"></exec>
		<exec executable="make" dir="${builddir}" failonerror="on">
			<arg line="dbschema"/>
		</exec>
	</target>

	<target name="init-sqlite3" depends="init-common">
		<!-- Create PostgreSQL database -->
		<exec executable="sqlite3" input="${builddir}/create/schema/sqlite3.sql" failonerror="on">
			<arg line="-init ${builddir}/tests/templates/sqlite3.init"/>
			<arg line="/tmp/${dbname}.db"/>
		</exec>
		<exec executable="sqlite3" input="${builddir}/create/data/data.sql" failonerror="on">
			<arg line="-init ${builddir}/tests/templates/sqlite3.init"/>
			<arg line="/tmp/${dbname}.db"/>
		</exec>
		<exec executable="sqlite3" input="${builddir}/create/data/images_sqlite3.sql" failonerror="on">
			<arg line="-init ${builddir}/tests/templates/sqlite3.init"/>
			<arg line="/tmp/${dbname}.db"/>
		</exec>

		<!-- Create PHP config file -->
		<exec executable="sed" failonerror="on" output="${builddir}/frontends/php/conf/zabbix.conf.php">
			<arg line="'s/{DBNAME}/\/tmp\/${dbname}.db/' ${builddir}/tests/templates/zabbix.conf.php.sqlite3"/>
		</exec>
		<exec executable="sed" failonerror="on" output="${basedir}/frontends/php/conf/zabbix.conf.php">
			<arg line="'s/{DBNAME}/\/tmp\/${dbname}.db/' ${builddir}/tests/templates/zabbix.conf.php.sqlite3"/>
		</exec>
		<exec executable="sed" failonerror="on" output="${builddir}/frontends/php/tests/bootstrap.php">
			<arg line="'s/{URL}/${url}/' ${builddir}/frontends/php/tests/bootstrap.php.template"/>
		</exec>
	</target>

	<target name="init-postgresql" depends="init-common">
		<!-- Create PostgreSQL database -->
		<exec executable="psql" failonerror="on">
			<arg line="template1 -c 'drop database if exists ${dbname};'"/>
		</exec>
		<exec executable="psql" failonerror="on">
			<arg line="template1 -c 'create database ${dbname};'"/>
		</exec>
		<exec executable="psql" input="${builddir}/create/schema/postgresql.sql" failonerror="on">
			<arg line="${dbname}"/>
		</exec>
		<exec executable="psql" input="${builddir}/create/data/images_postgresql.sql" failonerror="on">
			<arg line="${dbname}"/>
		</exec>
		<exec executable="psql" input="${builddir}/create/data/data.sql" failonerror="on">
			<arg line="${dbname}"/>
		</exec>

		<!-- Create PHP config file -->
		<exec executable="sed" failonerror="on" output="${builddir}/frontends/php/conf/zabbix.conf.php">
			<arg line="'s/{DBNAME}/${dbname}/' ${builddir}/tests/templates/zabbix.conf.php.postgresql"/>
		</exec>
		<exec executable="sed" failonerror="on" output="${basedir}/frontends/php/conf/zabbix.conf.php">
			<arg line="'s/{DBNAME}/${dbname}/' ${builddir}/tests/templates/zabbix.conf.php.postgresql"/>
		</exec>
		<exec executable="sed" failonerror="on" output="${builddir}/frontends/php/tests/bootstrap.php">
			<arg line="'s/{URL}/${url}/' ${builddir}/frontends/php/tests/bootstrap.php.template"/>
		</exec>
	</target>

	<target name="init-mysql" depends="init-common">
		<!-- Create MySQL database -->
		<exec executable="mysql" failonerror="on">
			<arg line="-uroot -e 'drop database if exists ${dbname};'"/>
		</exec>
		<exec executable="mysql" failonerror="on">
			<arg line="-uroot -e 'create database ${dbname};'"/>
		</exec>
		<exec executable="mysql" input="${builddir}/create/schema/mysql.sql" failonerror="on">
			<arg line="-uroot ${dbname}"/>
		</exec>
		<exec executable="mysql" input="${builddir}/create/data/images_mysql.sql" failonerror="on">
			<arg line="-uroot ${dbname}"/>
		</exec>
		<exec executable="mysql" input="${builddir}/create/data/data.sql" failonerror="on">
			<arg line="-uroot ${dbname}"/>
		</exec>

		<!-- Create PHP config file -->
		<exec executable="sed" failonerror="on" output="${builddir}/frontends/php/conf/zabbix.conf.php">
			<arg line="'s/{DBNAME}/${dbname}/' ${builddir}/tests/templates/zabbix.conf.php.mysql"/>
		</exec>
		<exec executable="sed" failonerror="on" output="${basedir}/frontends/php/conf/zabbix.conf.php">
			<arg line="'s/{DBNAME}/${dbname}/' ${builddir}/tests/templates/zabbix.conf.php.mysql"/>
		</exec>
		<exec executable="sed" failonerror="on" output="${builddir}/frontends/php/tests/bootstrap.php">
			<arg line="'s/{URL}/${url}/' ${builddir}/frontends/php/tests/bootstrap.php.template"/>
		</exec>
	</target>

	<target name="clean">
		<!-- Delete build directories from the previous run -->
		<delete failonerror="off">
			<fileset dir="${basedir}/build/logs" includes="**.*" />
			<fileset dir="${builddir}" includes="**.*" />
			<fileset dir="/tmp" includes="sqlite3.db" />
		</delete>
	</target>

	<target name="gui">
		<exec executable="phpunit" dir="${basedir}/frontends/php/tests" failonerror="off">
			<arg line="--log-junit=${basedir}/build/logs/phpunit.xml --bootstrap=${builddir}/frontends/php/tests/bootstrap.php all.php"/>
		</exec>
	</target>

	<target name="build-mysql" depends="clean,init-mysql,buildagent,buildproxy,buildserver,gui" />
	<target name="build-postgresql" depends="clean,init-postgresql,buildagent,buildproxy,buildserver,gui" />
	<target name="build-sqlite3" depends="clean,init-sqlite3,buildagent,buildproxy,buildserver,gui" />

	<!-- Default target -->
	<target name="build" depends="build-mysql,build-postgresql" />

</project>
