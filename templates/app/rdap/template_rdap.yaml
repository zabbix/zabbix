zabbix_export:
  version: '8.0'
  template_groups:
    - uuid: a571c0d144b14fd4a87a9d9b2aa9fcd6
      name: Templates/Applications
  templates:
    - uuid: a525b86c57da4d34853ff249b8b1f099
      template: 'Domain RDAP by HTTP'
      name: 'Domain RDAP by HTTP'
      description: |
        Monitor domain registration and related information using RDAP (Registration Data Access Protocol) over HTTP.
        
        Generated by official Zabbix template tool "Templator"
      wizard_ready: 'YES'
      readme: |
        ## Overview
        
        This template monitors domain registration and related information using RDAP (Registration Data Access Protocol) over HTTP. It retrieves data such as expiration dates, registrar information, status, and more for the specified domains. The template also includes low-level discovery (LLD) rules to automatically discover additional information like notices and entities associated with each domain.
        
        ## Setup
        
        Set values for the `parameters` according to your monitoring requirements.
        * `Domains`. **Required**. Enter one or more domains, separated by commas (e.g., example.com,test.net).
        * `Check interval for TLD registration data`. (Optional) TLD data does not change frequently. The default value of 12h (12 hours) or even 1d (1 day) is optimal to reduce the load on the Zabbix server and external RDAP services.
        * `Check interval for domain registration data`. (Optional) Use 1h as the standard. Checking too frequently may cause rate-limiting by RDAP services.
        
        ### Notes
        * Accepts seconds or time unit with suffix (e.g., 30s, 1m, 2h, 1d) and, optionally, one or more custom intervals, all separated by semicolons.
      vendor:
        name: Zabbix
        version: 8.0-0
      groups:
        - name: Templates/Applications
      items:
        - uuid: 5c8826ceba6242378a1a85ff21ba4669
          name: 'Get registration data for domains'
          type: SCRIPT
          key: rdap.domain.info
          delay: '{$RDAP.INTERVAL.TLD.CHECK}'
          history: '0'
          value_type: TEXT
          params: |
            
            var RDAP = {
            	params: {},
            	iana_dns_bootstrap_url: 'https://data.iana.org/rdap/dns.json',
            	services: [],
            
            	setParams: function (params) {
            		RDAP.params['proxy'] = params.proxy;
            		RDAP.getServiceUrls();
            		['domains', 'enable_additional_info'].forEach(function (field) {
            			if (typeof params !== 'object' || typeof params[field] === 'undefined' || params[field] === '') {
            				throw 'Required param is not set: "' + field + '".';
            			}
            			RDAP.params[field] = params[field];
            		});
            	},
            
            	getField: function (data, path, debug_info) {
            		var steps = path.split('.');
            
            		for (var i = 0; i < steps.length; i++) {
            			var step = steps[i];
            
            			if (typeof data !== 'object' || data === null || typeof data[step] === 'undefined') {
            				var error_message = 'Field not found: ' + path;
            
            				if (typeof debug_info !== 'undefined') {
            					error_message += ' (' + debug_info + ')';
            				}
            				throw error_message;
            			}
            			data = data[step];
            		}
            
            		return data;
            	},
            
            	getServiceUrls: function () {
            		var request = new HttpRequest();
            
            		if (typeof RDAP.params.proxy !== 'undefined' && RDAP.params.proxy !== '') {
            			request.setProxy(RDAP.params.proxy);
            		}
            
            		var response = request.get(RDAP.iana_dns_bootstrap_url);
            
            		if (request.getStatus() !== 200) {
            			throw 'Failed to retrieve IANA RDAP bootstrap data' + request.getStatus() + ': ' + response;
            		}
            
            		try {
            			response = JSON.parse(response);
            		} catch (error) {
            			throw 'Failed to parse IANA RDAP bootstrap data: ' + error;
            		}
            
            		RDAP.services = RDAP.getField(response, 'services', 'IANA RDAP bootstrap data');
            
            		if (!Array.isArray(RDAP.services) || RDAP.services.length === 0) {
            			throw 'No RDAP services found in IANA RDAP bootstrap data.';
            		}
            	},
            
            	findRdapServer: function (tld) {
            
            		for (var i = 0; i < RDAP.services.length; i++) {
            			var service = RDAP.services[i],
            				tlds = service[0] || [],
            				urls = service[1] || [''];
            			if (tlds.indexOf(tld) !== -1) {
            				return urls[0];
            			}
            		}
            		Zabbix.log(3, '[ RDAP ] No RDAP server found for domain: ' + tld);
            
            		return '';
            	},
            
            	discoverDomainRdap: function () {
            		var lld_data = [],
            			domains = RDAP.params['domains'].split(',');
            
            		for (var i = 0; i < domains.length; i++) {
            			var domain = domains[i].trim();
            
            			if (domain.endsWith('.')) {
            				domain = domain.slice(0, -1);
            			}
            
            			if (domain === '') {
            				continue;
            			}
            
            			var tld = domain.split('.').pop().toLowerCase(),
            				rdap_server = RDAP.findRdapServer(tld);
            
            			if (rdap_server !== '' && !rdap_server.endsWith('/')) {
            				rdap_server += '/';
            			}
            
            			lld_data.push({
            				'{#DOMAIN}': domain,
            				'{#TLD}': tld,
            				'{#RDAP_SERVER}': rdap_server,
            				'{#LLD.ADDITIONAL.INFO.ENABLED}': RDAP.params['enable_additional_info']
            			});
            		}
            
            		return lld_data;
            	}
            };
            
            try {
            	RDAP.setParams(JSON.parse(value));
            
            	return JSON.stringify({
            		data: RDAP.discoverDomainRdap(),
            		error: ''
            	});
            
            } catch (error) {
            	error += (String(error).endsWith('.')) ? '' : '.';
            	Zabbix.log(3, '[ RDAP ] ERROR: ' + error);
            
            	return JSON.stringify({
            		data: [],
            		error: error
            	});
            }
          description: 'Get registration data for domains using RDAP protocol over HTTP.'
          timeout: 30s
          parameters:
            - name: domains
              value: '{$RDAP.DOMAINS}'
            - name: enable_additional_info
              value: '{$RDAP.LLD.ADDITIONAL.INFO.ENABLED}'
          tags:
            - tag: component
              value: raw
        - uuid: 41257fcc5ac646779be2ebce750679e9
          name: 'Error retrieving registration data for domains'
          type: DEPENDENT
          key: rdap.domain.info.error
          value_type: TEXT
          description: 'Error message when retrieving registration data for domains.'
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
            - type: JSONPATH
              parameters:
                - $.error
              error_handler: CUSTOM_VALUE
              error_handler_params: 'Error retrieving registration data.'
          master_item:
            key: rdap.domain.info
          tags:
            - tag: component
              value: error
            - tag: component
              value: system
          triggers:
            - uuid: 460618aa9f5f4832a60d105b94cf320c
              expression: 'last(/Domain RDAP by HTTP/rdap.domain.info.error)<>""'
              name: 'RDAP: Error retrieving registration data for domains'
              opdata: 'Retrieving registration data failed. Error: {ITEM.VALUE}'
              priority: HIGH
              tags:
                - tag: scope
                  value: notice
      discovery_rules:
        - uuid: a6f433cb96e641b0ae459a38926eac2e
          name: 'Discovery entities for domain [{#DOMAIN}]'
          type: DEPENDENT
          key: 'rdap.domain.entities.discovery[{#DOMAIN}]'
          description: 'Discover entities for domain `{#DOMAIN}`.'
          item_prototypes:
            - uuid: e206793ce1674fefa27334566c1bea91
              name: '[{#DOMAIN}]: {#ENTITY_VCARD_NAME}'
              type: SCRIPT
              key: 'rdap.domain.entity.vcard.entry[{#DOMAIN},{#ENTITY_VCARD_KEY}]'
              delay: '{$RDAP.INTERVAL.DOMAIN.CHECK}'
              value_type: TEXT
              params: 'return ''{#ENTITY_VCARD_VALUE}'';'
              description: 'Information about entity `{#ENTITY_ROLE} {#ENTITY_SUB_ROLE}`.'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
              tags:
                - tag: component
                  value: entity
                - tag: component
                  value: system
                - tag: domain
                  value: '{#DOMAIN}'
                - tag: role
                  value: '{#ENTITY_ROLE}'
                - tag: subrole
                  value: '{#ENTITY_SUB_ROLE}'
          parent_discovery_rule:
            key: rdap.domain.with.rdap.discovery
          master_item:
            key: 'rdap.domain.data[{#DOMAIN}]'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.lld_entities
              error_handler: CUSTOM_VALUE
              error_handler_params: '[]'
        - uuid: 5c14da924e3443c6b255b87f684d2e5a
          name: 'Discovery notices for domain [{#DOMAIN}]'
          type: DEPENDENT
          key: 'rdap.domain.notices.discovery[{#DOMAIN}]'
          description: 'Discover notices for domain `{#DOMAIN}`.'
          item_prototypes:
            - uuid: 9d33ba74c2be44bba340b398d6679799
              name: '[{#DOMAIN}]: Notice [{#NOTICE_TITLE}]'
              type: SCRIPT
              key: 'rdap.domain.notice.title[{#DOMAIN},{#NOTICE_TITLE}]'
              delay: '{$RDAP.INTERVAL.DOMAIN.CHECK}'
              value_type: TEXT
              params: 'return ''{#NOTICE_LINKS}'';'
              description: '{#NOTICE_DESCRIPTION}'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
              tags:
                - tag: component
                  value: notice
                - tag: component
                  value: system
                - tag: domain
                  value: '{#DOMAIN}'
          parent_discovery_rule:
            key: rdap.domain.with.rdap.discovery
          master_item:
            key: 'rdap.domain.data[{#DOMAIN}]'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.lld_notices
              error_handler: CUSTOM_VALUE
              error_handler_params: '[]'
        - uuid: d1f3f4e2f3b14f8eaed3f4c6e2b5a7c1
          name: 'Discovery domains with RDAP server'
          type: DEPENDENT
          key: rdap.domain.with.rdap.discovery
          description: 'Discover domains using RDAP protocol over HTTP.'
          item_prototypes:
            - uuid: 3e6efaa0c85a4cabb175d162e2c39e57
              name: '[{#DOMAIN}]: Authority RDAP server'
              type: DEPENDENT
              key: 'rdap.domain.authority[{#DOMAIN}]'
              value_type: TEXT
              discover: NO_DISCOVER
              description: 'Authority RDAP server for `{#TLD}` domain.'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
                - type: JSONPATH
                  parameters:
                    - '$.data[?(@.domain=="{#DOMAIN}")].rdap_server.first()'
                  error_handler: CUSTOM_VALUE
              master_item:
                key: rdap.domain.info
              tags:
                - tag: component
                  value: system
                - tag: domain
                  value: '{#DOMAIN}'
              trigger_prototypes:
                - uuid: 6d04d884bae84663abd5459dbfaa0035
                  expression: 'last(/Domain RDAP by HTTP/rdap.domain.authority[{#DOMAIN}])=""'
                  name: 'RDAP: [{#DOMAIN}] authority RDAP server not found'
                  discover: NO_DISCOVER
                  priority: WARNING
                  description: |
                    The domain is not registered, there's a typo in your query, 
                    or the initial bootstrap service is unable to locate 
                    the correct server to direct the request to.
                  tags:
                    - tag: scope
                      value: notice
            - uuid: f62bbd29cecd47b7ab3f251367f9ddf6
              name: '[{#DOMAIN}]: Last changed'
              type: DEPENDENT
              key: 'rdap.domain.changed[{#DOMAIN}]'
              units: unixtime
              description: 'Last changed date for domain `{#DOMAIN}`.'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
                - type: JSONPATH
                  parameters:
                    - '$.events[?(@.eventAction=="last changed")].eventDate.first()'
                  error_handler: DISCARD_VALUE
                - type: JAVASCRIPT
                  parameters:
                    - 'return Math.floor(Date.parse(value) / 1000);'
              master_item:
                key: 'rdap.domain.data[{#DOMAIN}]'
              tags:
                - tag: component
                  value: system
                - tag: domain
                  value: '{#DOMAIN}'
              trigger_prototypes:
                - uuid: bd8c5df907854cea9aa4042e0a179553
                  expression: '(now() - last(/Domain RDAP by HTTP/rdap.domain.changed[{#DOMAIN}])) < 604800'
                  name: 'RDAP: [{#DOMAIN}] was changed recently'
                  opdata: 'Last changed date: {ITEM.LASTVALUE}'
                  priority: INFO
                  description: 'Domain `{#DOMAIN}` was changed in the last 7 days. Acknowledge to close the problem manually.'
                  manual_close: 'YES'
                  tags:
                    - tag: scope
                      value: notice
            - uuid: bff6beaac1f6473d985588e2b22f44cc
              name: '[{#DOMAIN}]: Get data'
              type: HTTP_AGENT
              key: 'rdap.domain.data[{#DOMAIN}]'
              delay: '{$RDAP.INTERVAL.DOMAIN.CHECK}'
              history: '0'
              value_type: TEXT
              description: 'Get registration data for domain `{#DOMAIN}` using RDAP protocol over HTTP.'
              preprocessing:
                - type: CHECK_NOT_SUPPORTED
                  parameters:
                    - '-1'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '{"status": ["Error get data"], "lld_notices": [], "lld_entities": []}'
                - type: CHECK_JSON_ERROR
                  parameters:
                    - $.errorCode
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '{"status": ["Error get data"], "lld_notices": [], "lld_entities": []}'
                - type: JAVASCRIPT
                  parameters:
                    - |
                      function getField(data, path, default_value) {
                      	var steps = path.split('.');
                      
                      	for (var i = 0; i < steps.length; i++) {
                      		var step = steps[i];
                      
                      		if (typeof data !== 'object' || data === null || typeof data[step] === 'undefined') {
                      			return default_value;
                      		}
                      		data = data[step];
                      	}
                      
                      	return data;
                      }
                      
                      function getVcardData(vcard) {
                      
                      	var vcard_clear = [getField(vcard, '0', ''), getField(vcard, '3', '')];
                      
                      	for (var j = 0; j < vcard_clear.length; j++) {
                      		if (!Array.isArray(vcard_clear[j])) {
                      			vcard_clear[j] = [vcard_clear[j]];
                      		}
                      
                      		vcard_clear[j] = vcard_clear[j].map(function (el) {
                      			if (Array.isArray(el)) {
                      				el = el.filter(function (el) {
                      					return el.trim() !== '';
                      				});
                      				return el.join(', ');
                      			}
                      
                      			return el.trim();
                      		});
                      
                      		vcard_clear[j] = vcard_clear[j].filter(function (el) {
                      			
                      			return el.trim() !== '';
                      		});
                      
                      		vcard_clear[j] = vcard_clear[j].join(', ');
                      	}
                      
                      	vcard_clear[1] = vcard_clear[1].replace(/[\']/g, '\\\'');
                      
                      	return vcard_clear;
                      }
                      
                      function getEntityData(parent_roles, parent_index, index, entity) {
                      
                      	var roles = getField(entity, 'roles', 'unknown'),
                      		out_vcard_array = [];
                      
                      	if (Array.isArray(roles)) {
                      		roles = roles.join(', ');
                      	}
                      
                      	var vcard_array = getField(entity, 'vcardArray', ['vcard', []]);
                      
                      	vcard_array = vcard_array[1];
                      
                      	for (var j = 0; j < vcard_array.length; j++) {
                      		vcard_array[j] = getVcardData(vcard_array[j]);
                      
                      		if (vcard_array[j][1] === '') {
                      			continue;
                      		}
                      
                      		var final_index = (parent_index === '' ? index : parent_index + ',' + index),
                      			final_roles = (parent_roles === '' ? roles : parent_roles + '-' + roles);
                      
                      		out_vcard_array.push({
                      			'{#ENTITY_VCARD_NAME}': '[' + final_roles + ']: vCard: [' + vcard_array[j][0] + ']',
                      			'{#ENTITY_VCARD_VALUE}': vcard_array[j][1],
                      			'{#ENTITY_VCARD_KEY}': final_index + ',' + j + ',' + vcard_array[j][0],
                      			'{#ENTITY_ROLE}': parent_roles === '' ? roles : parent_roles,
                      			'{#ENTITY_SUB_ROLE}': parent_roles === '' ? '' : roles
                      		});
                      	}
                      
                      	return out_vcard_array;
                      }
                      
                      var input_data = JSON.parse(value);
                      
                      input_data['lld_entities'] = [];
                      input_data['lld_notices'] = [];
                      
                      for (var i = 0; i < getField(input_data, 'entities', []).length; i++) {
                      	var entity = getField(input_data, 'entities.' + i, {}),
                      		entity_data = getEntityData('', '', i, entity);
                      
                      	input_data['lld_entities'] = input_data['lld_entities'].concat(entity_data);
                      
                      	var sub_entities = getField(entity, 'entities', []);
                      
                      	for (var j = 0; j < sub_entities.length; j++) {
                      		var sub_role = getField(entity, 'roles', []).join(', '),
                      			sub_entity_data = getEntityData(sub_role, i, j, sub_entities[j]);
                      
                      		input_data['lld_entities'] = input_data['lld_entities'].concat(sub_entity_data);
                      	}
                      }
                      
                      for (var i = 0; i < getField(input_data, 'notices', []).length; i++) {
                      	var notice = getField(input_data, 'notices.' + i, {});
                      
                      	input_data['lld_notices'].push({
                      		'{#NOTICE_TITLE}': getField(notice, 'title', 'Notice '),
                      		'{#NOTICE_DESCRIPTION}': getField(notice, 'description', ['']).join(', '),
                      		'{#NOTICE_LINKS}': getField(notice, 'links', [{ "href": "" }])[0]['href'],
                      		'{#NOTICE_INDEX}': i
                      	});
                      }
                      
                      return JSON.stringify(input_data);
              timeout: 15s
              url: '{#RDAP_SERVER}domain/{#DOMAIN}'
              status_codes: '200,301,302,403,404,429'
              tags:
                - tag: component
                  value: raw
                - tag: domain
                  value: '{#DOMAIN}'
            - uuid: 099b7d9d612f466a85fed86d38da3daa
              name: '[{#DOMAIN}]: Expiration date'
              type: DEPENDENT
              key: 'rdap.domain.expiration[{#DOMAIN}]'
              units: unixtime
              description: 'Expiration date for domain `{#DOMAIN}`.'
              valuemap:
                name: 'RDAP unknown date'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
                - type: JSONPATH
                  parameters:
                    - '$.events[?(@.eventAction=="expiration")].eventDate.first()'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '1970-01-01T00:00:00Z'
                - type: JAVASCRIPT
                  parameters:
                    - 'return Math.floor(Date.parse(value) / 1000);'
              master_item:
                key: 'rdap.domain.data[{#DOMAIN}]'
              tags:
                - tag: component
                  value: system
                - tag: domain
                  value: '{#DOMAIN}'
            - uuid: 003d8ebc6c6f494bb654bae2762594f8
              name: '[{#DOMAIN}]: Days until expiration'
              type: DEPENDENT
              key: 'rdap.domain.registrar.until[{#DOMAIN}]'
              value_type: FLOAT
              units: '!days'
              description: 'Days until expiration for domain `{#DOMAIN}`.'
              valuemap:
                name: 'RDAP expiration status'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
                - type: JAVASCRIPT
                  parameters:
                    - |
                      var days = Math.floor((value - Date.now() / 1000) / 86400);
                      
                      if (days < -365) {
                      	return -2;
                      } else if (days < 0) {
                      	return -1;
                      } else {
                      	return days;
                      }
              master_item:
                key: 'rdap.domain.expiration[{#DOMAIN}]'
              tags:
                - tag: component
                  value: system
                - tag: domain
                  value: '{#DOMAIN}'
              trigger_prototypes:
                - uuid: 5be9a88a65a14df29d374408f5d1238f
                  expression: 'last(/Domain RDAP by HTTP/rdap.domain.registrar.until[{#DOMAIN}]) = -2'
                  name: 'RDAP: [{#DOMAIN}] expiration date is unknown'
                  priority: AVERAGE
                  description: 'Expiration date not found for domain `{#DOMAIN}`.'
                  dependencies:
                    - name: 'RDAP: [{#DOMAIN}] not exist'
                      expression: 'last(/Domain RDAP by HTTP/rdap.domain.status[{#DOMAIN}])="Error get data"'
                  tags:
                    - tag: scope
                      value: notice
                - uuid: 3a4f5e6d7c8b4a9ea0b1c2d3e4f5a6b7
                  expression: 'last(/Domain RDAP by HTTP/rdap.domain.registrar.until[{#DOMAIN}]) = -1'
                  name: 'RDAP: [{#DOMAIN}] is expired'
                  opdata: 'Expiration date: {ITEM.LASTVALUE}'
                  priority: HIGH
                  description: 'Domain `{#DOMAIN}` expiration date is in the past.'
                  dependencies:
                    - name: 'RDAP: [{#DOMAIN}] expiration date is unknown'
                      expression: 'last(/Domain RDAP by HTTP/rdap.domain.registrar.until[{#DOMAIN}]) = -2'
                  tags:
                    - tag: scope
                      value: notice
                - uuid: ebf8c3228395461bb50ea8fe3158e513
                  expression: 'last(/Domain RDAP by HTTP/rdap.domain.registrar.until[{#DOMAIN}]) < {$RDAP.EXPIRATION.WARNING.DAYS:"{#DOMAIN}"}'
                  name: 'RDAP: [{#DOMAIN}] will expire soon'
                  opdata: 'Expiration date: {ITEM.LASTVALUE}'
                  priority: HIGH
                  description: 'Until domain `{#DOMAIN}` expiration left is less than {$RDAP.EXPIRATION.WARNING.DAYS:"{#DOMAIN}"} days.'
                  dependencies:
                    - name: 'RDAP: [{#DOMAIN}] expiration date is unknown'
                      expression: 'last(/Domain RDAP by HTTP/rdap.domain.registrar.until[{#DOMAIN}]) = -2'
                    - name: 'RDAP: [{#DOMAIN}] is expired'
                      expression: 'last(/Domain RDAP by HTTP/rdap.domain.registrar.until[{#DOMAIN}]) = -1'
                  tags:
                    - tag: scope
                      value: notice
            - uuid: 602bca3920f045158710327c133cb45d
              name: '[{#DOMAIN}]: Registrar'
              type: DEPENDENT
              key: 'rdap.domain.registrar[{#DOMAIN}]'
              units: unixtime
              description: 'Registrar for domain `{#DOMAIN}`.'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
                - type: JSONPATH
                  parameters:
                    - '$.events[?(@.eventAction=="registration")].eventDate.first()'
                  error_handler: DISCARD_VALUE
                - type: JAVASCRIPT
                  parameters:
                    - 'return Math.floor(Date.parse(value) / 1000);'
              master_item:
                key: 'rdap.domain.data[{#DOMAIN}]'
              tags:
                - tag: component
                  value: system
                - tag: domain
                  value: '{#DOMAIN}'
            - uuid: 0b6f1a04068c4927b51cd85326d50184
              name: '[{#DOMAIN}]: Status'
              type: DEPENDENT
              key: 'rdap.domain.status[{#DOMAIN}]'
              value_type: TEXT
              description: 'Status of domain `{#DOMAIN}`.'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
                - type: JSONPATH
                  parameters:
                    - $.status
                  error_handler: DISCARD_VALUE
                - type: JAVASCRIPT
                  parameters:
                    - 'return JSON.parse(value).join('', '');'
              master_item:
                key: 'rdap.domain.data[{#DOMAIN}]'
              tags:
                - tag: component
                  value: system
                - tag: domain
                  value: '{#DOMAIN}'
              trigger_prototypes:
                - uuid: 203afdad58a44cfabd5a74836a46886d
                  expression: 'last(/Domain RDAP by HTTP/rdap.domain.status[{#DOMAIN}])="Error get data"'
                  name: 'RDAP: [{#DOMAIN}] not exist'
                  priority: AVERAGE
                  description: 'Status information not found for domain `{#DOMAIN}`. The domain may not be registered or there was an error retrieving the data.'
                  tags:
                    - tag: scope
                      value: notice
                - uuid: aae204ffd0b64225b66516fe95492ece
                  expression: 'length(last(/Domain RDAP by HTTP/rdap.domain.status[{#DOMAIN}]))>0 and change(/Domain RDAP by HTTP/rdap.domain.status[{#DOMAIN}])=1'
                  name: 'RDAP: [{#DOMAIN}] status was changed recently'
                  priority: WARNING
                  description: 'Domain `{#DOMAIN}` was changed recently. Acknowledge to close the problem manually.'
                  manual_close: 'YES'
                  dependencies:
                    - name: 'RDAP: [{#DOMAIN}] not exist'
                      expression: 'last(/Domain RDAP by HTTP/rdap.domain.status[{#DOMAIN}])="Error get data"'
                  tags:
                    - tag: scope
                      value: notice
            - uuid: 8f3e2f3b1a5e4c2b9f4e6d7c8b9a0b1c
              name: '[{#DOMAIN}]: Last update of RDAP data'
              type: DEPENDENT
              key: 'rdap.domain.updated[{#DOMAIN}]'
              units: unixtime
              description: 'Last update date of RDAP data for domain `{#DOMAIN}`.'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
                - type: JSONPATH
                  parameters:
                    - '$.events[?(@.eventAction=="last update of RDAP database")].eventDate.first()'
                  error_handler: DISCARD_VALUE
                - type: JAVASCRIPT
                  parameters:
                    - 'return Math.floor(Date.parse(value) / 1000);'
              master_item:
                key: 'rdap.domain.data[{#DOMAIN}]'
              tags:
                - tag: component
                  value: system
                - tag: domain
                  value: '{#DOMAIN}'
              trigger_prototypes:
                - uuid: 66cd46d10af74981ad089ee0d0333931
                  expression: '(now() - last(/Domain RDAP by HTTP/rdap.domain.updated[{#DOMAIN}])) / 86400 > {$RDAP.NOT.UPDATED.WARNING.DAYS:"{#DOMAIN}"}'
                  name: 'RDAP: [{#DOMAIN}] not updated data for {$RDAP.NOT.UPDATED.WARNING.DAYS:"{#DOMAIN}"} days'
                  opdata: 'Last update of RDAP data: {ITEM.LASTVALUE}'
                  priority: INFO
                  description: 'RDAP data for domain `{#DOMAIN}` not updated for {$RDAP.NOT.UPDATED.WARNING.DAYS:"{#DOMAIN}"} days. Acknowledge to close the problem manually.'
                  manual_close: 'YES'
                  tags:
                    - tag: scope
                      value: notice
          master_item:
            key: rdap.domain.info
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.data
          overrides:
            - name: 'Authority server'
              step: '1'
              filter:
                conditions:
                  - macro: '{#RDAP_SERVER}'
                    value: ^$
              operations:
                - operator: REGEXP
                  value: 'Authority RDAP server'
                  discover: DISCOVER
                - operator: REGEXP
                  value: 'Expiration date'
                  discover: NO_DISCOVER
                - operator: REGEXP
                  value: 'Get data'
                  discover: NO_DISCOVER
                - operator: REGEXP
                  value: 'Last changed'
                  discover: NO_DISCOVER
                - operator: REGEXP
                  value: 'Last update of RDAP data'
                  discover: NO_DISCOVER
                - operator: REGEXP
                  value: Registrar
                  discover: NO_DISCOVER
                - operator: REGEXP
                  value: Status
                  discover: NO_DISCOVER
                - operationobject: TRIGGER_PROTOTYPE
                  operator: LIKE
                  value: 'authority RDAP server not found'
                  discover: DISCOVER
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'RDAP: * expiration date is unknown'
                  discover: NO_DISCOVER
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'RDAP: * is expired'
                  discover: NO_DISCOVER
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'RDAP: * not updated data for * days'
                  discover: NO_DISCOVER
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'RDAP: * status was changed recently'
                  discover: NO_DISCOVER
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'RDAP: * was changed recently'
                  discover: NO_DISCOVER
                - operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'RDAP: * will expire soon'
                  discover: NO_DISCOVER
            - name: 'Additional info discovery'
              step: '2'
              filter:
                evaltype: OR
                conditions:
                  - macro: '{#LLD.ADDITIONAL.INFO.ENABLED}'
                    value: ^1$
                    operator: NOT_MATCHES_REGEX
                  - macro: '{#RDAP_SERVER}'
                    value: ^$
              operations:
                - operationobject: LLD_RULE_PROTOTYPE
                  operator: REGEXP
                  value: 'Discovery entities for domain *'
                  discover: NO_DISCOVER
                - operationobject: LLD_RULE_PROTOTYPE
                  operator: REGEXP
                  value: 'Discovery notices for domain *'
                  discover: NO_DISCOVER
      tags:
        - tag: class
          value: network
        - tag: target
          value: rdap
      macros:
        - macro: '{$RDAP.DOMAINS}'
          description: 'List of domains separated by commas.'
          config:
            type: TEXT
            priority: '1'
            label: Domains
            description: 'List of domains to monitor, separated by commas.'
            required: 'YES'
        - macro: '{$RDAP.EXPIRATION.WARNING.DAYS}'
          value: '7'
          description: 'Number of days before expiration to trigger a warning.'
          config:
            type: TEXT
            priority: '3'
            label: 'Expiration warning days'
            description: 'Number of days before a domain''s expiration date to trigger a warning.'
            regex: ^\d+$
        - macro: '{$RDAP.INTERVAL.DOMAIN.CHECK}'
          value: 1h
          description: 'Interval for checking domain registration data.'
          config:
            type: TEXT
            priority: '6'
            label: 'Check interval for domain registration data'
            description: |
              Interval for checking domain registration data using RDAP.
              Accepts seconds or time unit with suffix (e.g., 30s, 1m, 2h, 1d) and, optionally, 
              one or more custom intervals, all separated by semicolons. 
              Custom intervals can be a mix of flexible and scheduling intervals.
        - macro: '{$RDAP.INTERVAL.TLD.CHECK}'
          value: 12h
          description: 'Interval for checking TLD registration data.'
          config:
            type: TEXT
            priority: '5'
            label: 'Check interval for TLD registration data'
            description: |
              Interval for checking TLD registration data using RDAP.
              Accepts seconds or time unit with suffix (e.g., 30s, 1m, 2h, 1d) and, optionally, 
              one or more custom intervals, all separated by semicolons. 
              Custom intervals can be a mix of flexible and scheduling intervals.
        - macro: '{$RDAP.LLD.ADDITIONAL.INFO.ENABLED}'
          value: '1'
          description: 'Enable discovery additional information in LLD (1 - enabled, 0 - disabled).'
          config:
            type: CHECKBOX
            priority: '2'
            label: 'Enable additional info discovery'
            description: 'Enable discovery of additional information such as notices and entities in low-level discovery (LLD).'
            options:
              - checked: '1'
                unchecked: '0'
        - macro: '{$RDAP.NOT.UPDATED.WARNING.DAYS}'
          value: '7'
          description: 'Number of days after last update to trigger a warning.'
          config:
            type: TEXT
            priority: '4'
            label: 'Not updated warning days'
            description: 'Number of days after the last update of RDAP data to trigger a warning.'
            regex: ^\d+$
      dashboards:
        - uuid: 8f39eba3462b479190222e737befca7c
          name: 'RDAP overview'
          display_period: '3600'
          auto_start: 'NO'
          pages:
            - widgets:
                - type: honeycomb
                  width: '40'
                  height: '8'
                  fields:
                    - type: STRING
                      name: items.0
                      value: '[*]: Days until expiration'
                    - type: INTEGER
                      name: maintenance
                      value: '1'
                    - type: STRING
                      name: primary_label
                      value: '{{ITEM.NAME}.regsub("^\[([\S]+)\]: Days until expiration$", "\1")}'
                    - type: STRING
                      name: reference
                      value: ZPTDF
                    - type: INTEGER
                      name: rf_rate
                      value: '900'
                    - type: INTEGER
                      name: secondary_label_decimal_places
                      value: '0'
                    - type: STRING
                      name: thresholds.0.color
                      value: 97AAB3
                    - type: STRING
                      name: thresholds.0.threshold
                      value: '-2'
                    - type: STRING
                      name: thresholds.1.color
                      value: E45959
                    - type: STRING
                      name: thresholds.1.threshold
                      value: '0'
                    - type: STRING
                      name: thresholds.2.color
                      value: FFBF59
                    - type: STRING
                      name: thresholds.2.threshold
                      value: '7'
                    - type: STRING
                      name: thresholds.3.color
                      value: 00C48C
                    - type: STRING
                      name: thresholds.3.threshold
                      value: '30'
                    - type: STRING
                      name: thresholds.4.color
                      value: 00684a
                    - type: STRING
                      name: thresholds.4.threshold
                      value: '500'
                - type: itemnavigator
                  name: Events
                  'y': '8'
                  width: '14'
                  height: '6'
                  hide_header: 'YES'
                  fields:
                    - type: INTEGER
                      name: group_by.0.attribute
                      value: '3'
                    - type: STRING
                      name: group_by.0.tag_name
                      value: domain
                    - type: STRING
                      name: items.0
                      value: '[*]: Expiration date'
                    - type: STRING
                      name: items.1
                      value: '[*]: Last changed'
                    - type: STRING
                      name: items.2
                      value: '[*]: Last update of RDAP data'
                    - type: STRING
                      name: items.3
                      value: '[*]: Registrar'
                    - type: STRING
                      name: reference
                      value: VRFTU
                    - type: INTEGER
                      name: rf_rate
                      value: '0'
                    - type: INTEGER
                      name: show_lines
                      value: '1000'
                - type: item
                  x: '14'
                  'y': '8'
                  width: '22'
                  height: '3'
                  hide_header: 'YES'
                  fields:
                    - type: INTEGER
                      name: decimal_places
                      value: '0'
                    - type: INTEGER
                      name: decimal_size
                      value: '45'
                    - type: STRING
                      name: itemid._reference
                      value: ZPTDF._itemid
                    - type: INTEGER
                      name: rf_rate
                      value: '0'
                    - type: INTEGER
                      name: show.0
                      value: '1'
                    - type: INTEGER
                      name: show.1
                      value: '2'
                    - type: STRING
                      name: thresholds.0.color
                      value: 97AAB3
                    - type: STRING
                      name: thresholds.0.threshold
                      value: '-2'
                    - type: STRING
                      name: thresholds.1.color
                      value: E45959
                    - type: STRING
                      name: thresholds.1.threshold
                      value: '0'
                    - type: STRING
                      name: thresholds.2.color
                      value: FFBF59
                    - type: STRING
                      name: thresholds.2.threshold
                      value: '7'
                    - type: STRING
                      name: thresholds.3.color
                      value: 00C48C
                    - type: STRING
                      name: thresholds.3.threshold
                      value: '30'
                    - type: INTEGER
                      name: units_size
                      value: '25'
                    - type: INTEGER
                      name: value_size
                      value: '35'
                - type: item
                  x: '14'
                  'y': '11'
                  width: '22'
                  height: '3'
                  hide_header: 'YES'
                  fields:
                    - type: INTEGER
                      name: decimal_places
                      value: '0'
                    - type: STRING
                      name: itemid._reference
                      value: VRFTU._itemid
                    - type: INTEGER
                      name: rf_rate
                      value: '0'
                    - type: INTEGER
                      name: show.0
                      value: '2'
                    - type: INTEGER
                      name: show.1
                      value: '1'
                    - type: INTEGER
                      name: value_size
                      value: '35'
                - type: itemnavigator
                  name: 'Entity data'
                  x: '36'
                  'y': '8'
                  width: '15'
                  height: '6'
                  hide_header: 'YES'
                  fields:
                    - type: INTEGER
                      name: group_by.0.attribute
                      value: '3'
                    - type: STRING
                      name: group_by.0.tag_name
                      value: domain
                    - type: INTEGER
                      name: group_by.1.attribute
                      value: '3'
                    - type: STRING
                      name: group_by.1.tag_name
                      value: role
                    - type: INTEGER
                      name: group_by.2.attribute
                      value: '3'
                    - type: STRING
                      name: group_by.2.tag_name
                      value: subrole
                    - type: INTEGER
                      name: item_tags.0.operator
                      value: '1'
                    - type: STRING
                      name: item_tags.0.tag
                      value: component
                    - type: STRING
                      name: item_tags.0.value
                      value: entity
                    - type: STRING
                      name: reference
                      value: MATXD
                    - type: INTEGER
                      name: rf_rate
                      value: '0'
                    - type: INTEGER
                      name: show_lines
                      value: '1000'
                - type: problems
                  x: '40'
                  width: '32'
                  height: '8'
                  fields:
                    - type: STRING
                      name: reference
                      value: XEVSV
                    - type: INTEGER
                      name: rf_rate
                      value: '900'
                    - type: INTEGER
                      name: show
                      value: '3'
                    - type: INTEGER
                      name: show_lines
                      value: '100'
                    - type: INTEGER
                      name: show_timeline
                      value: '0'
                    - type: INTEGER
                      name: sort_triggers
                      value: '15'
                - type: itemcard
                  x: '51'
                  'y': '8'
                  width: '21'
                  height: '6'
                  fields:
                    - type: STRING
                      name: itemid._reference
                      value: MATXD._itemid
                    - type: INTEGER
                      name: rf_rate
                      value: '0'
                    - type: INTEGER
                      name: sections.0
                      value: '0'
                    - type: INTEGER
                      name: sections.1
                      value: '3'
                    - type: INTEGER
                      name: sections.2
                      value: '9'
                    - type: INTEGER
                      name: sections.3
                      value: '7'
      valuemaps:
        - uuid: 2aeb1024e7b94b93b3cac55d2b9ae7bc
          name: 'RDAP expiration status'
          mappings:
            - value: '0'
              newvalue: 'Expire today'
            - type: IN_RANGE
              value: '1 - 7'
              newvalue: 'Expire soon'
            - type: IN_RANGE
              value: '8 - 30'
              newvalue: 'Expires in less than a month'
            - value: '-1'
              newvalue: 'Registration has expired'
            - value: '-2'
              newvalue: Unknown
        - uuid: 2314cc11c34d4a61873b41ab00559b14
          name: 'RDAP unknown date'
          mappings:
            - value: '0'
              newvalue: Unknown
