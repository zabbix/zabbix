# https://support.zabbix.com/browse/ZBX-8530

fixtures:
  hostGroup:
    type: include
    params:
      file: hostGroup

  hostWithItem:
    type: include
    params:
      file: hostWithItem
      params:
        groupid: @fixtures.hostGroup.result.groupid@

  templateWithItem:
    type: include
    params:
      file: templateWithItem
      params:
        groupid: @fixtures.hostGroup.result.groupid@

  # link the template to the host
  linkTemplate:
    type: api
    params:
      method: host.update
      params:
        hostid: @fixtures.hostWithItem.result.hostid@
        templates: { templateid: @fixtures.templateWithItem.result.templateid@ }
        inventory: {}
        interfaces:
          -
            interfaceid: @fixtures.hostWithItem.result.interfaceid@
            main: 0
            type: 1
            useip: 1
            ip: "0.0.0.0"
            dns: ""
            port: 10050
            bulk: 1
          -
            main: 1
            type: 1
            useip: 1
            ip: "0.0.0.0"
            dns: ""
            port: 10050
            bulk: 1

steps:

  # unlink and clear the template and remove the interface used by the item
  step1:
    request:
      method: host.update
      params:
        hostid: @fixtures.hostWithItem.result.hostid@
        templates_clear: [{ templateid: @fixtures.templateWithItem.result.templateid@] }]
        interfaces:
          -
            interfaceid: 2
            main: 1
            type: 1
            useip: 1
            ip: "0.0.0.0"
            dns: ""
            port: 10050
            bulk: 1


    expect: result
    response:
      hostids: [@fixtures.hostWithItem.result.hostid@]

  # make sure step2 has been executed correctly
  step2:
    request:
      method: host.get
      params:
        hostids: 1
        output: [hostid]
        selectParentTemplates: [templateid]
        selectItems: [name]
        selectInterfaces: [interfaceid]

    expect: result
    response:
      -
        hostid: 1
        parentTemplates: []
        items: []
        interfaces: [{ interfaceid: 2 }]
