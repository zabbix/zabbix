# https://support.zabbix.com/browse/ZBX-8530

fixtures:
  hostWithItem:
    groupid: @fixtures.base.result.groupid@

  templateWithItem:
    groupid: @fixtures.base.result.groupid@

  # link the template to the host
  linkTemplate:
    type: api
    params:
      method: host.update
      params:
        hostid: @fixtures.hostWithItem.result.hostid@
        templates: { templateid: @fixtures.templateWithItem.result.templateid@ }
        # TODO: the inventory parameter has been added to avoid ZBX-8779
        inventory: {}
        interfaces:
          -
            interfaceid: @fixtures.hostWithItem.result.interfaceid@
            main: 0
            type: 1
            useip: 1
            ip: "0.0.0.0"
            dns: ""
            port: 10050
            bulk: 1
          -
            main: 1
            type: 1
            useip: 1
            ip: "0.0.0.0"
            dns: ""
            port: 10050
            bulk: 1

  # get the IDs of the new interfaces
  interfaces:
    type: api
    params:
      method: host.get
      params:
        output: ["hostid"]
        selectInterfaces: ["interfaceid"]
        hostids: @fixtures.hostWithItem.result.hostid@

steps:

  # unlink and clear the template and remove the interface used by the item
  step1:
    request:
      method: host.update
      params:
        hostid: @fixtures.hostWithItem.result.hostid@
        templates_clear: [{ templateid: @fixtures.templateWithItem.result.templateid@] }]
        interfaces:
          -
            interfaceid: @fixtures.interfaces.result[0].interfaces[1].interfaceid@
            main: 1
            type: 1
            useip: 1
            ip: "0.0.0.0"
            dns: ""
            port: 10050
            bulk: 1


    expect: result
    response:
      hostids: [@fixtures.hostWithItem.result.hostid@]

  # make sure step2 has been executed correctly
  step2:
    request:
      method: host.get
      params:
        hostids: 1
        output: [hostid]
        selectParentTemplates: [templateid]
        selectItems: [name]
        selectInterfaces: [interfaceid]

    expect: result
    response:
      -
        hostid: @fixtures.hostWithItem.result.hostid@
        parentTemplates: []
        items: []
        interfaces: [{ interfaceid: @fixtures.interfaces.result[0].interfaces[1].interfaceid@ }]
